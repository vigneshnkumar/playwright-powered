name: Playwright Tests

# Trigger CI on push to main and on all pull requests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Allow manual workflow runs from Actions tab
  workflow_dispatch:

jobs:
  test:
    # Job timeout (prevents hanging tests from blocking CI)
    timeout-minutes: 20
    
    # Run on latest Ubuntu (also works on windows-latest, macos-latest)
    runs-on: ubuntu-latest 
    
    steps:
    # 1. Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Setup Node.js (v20 LTS, change if needed)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm' # Cache node_modules for faster subsequent runs

    # 3. Install dependencies (production + dev)
    - name: Install dependencies
      run: npm ci
      # npm ci is faster than npm install and ensures clean installs
      # Uses package-lock.json for deterministic dependencies

    # 4. Install Playwright browsers (Chromium only, as per config)
    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps
      # --with-deps: Installs system dependencies (fonts, media codecs)
      # chromium: Only install Chromium (faster than --with-deps alone)

    # 5. Run Playwright tests
    - name: Run Playwright tests
      run: npx playwright test
      env:
        CI: true # Triggers CI-specific config (retries, workers, etc.)
      # This uses settings from playwright.config.ts:
      # - retries: 2 (auto-retry flaky tests)
      # - workers: process.env.CI ? 8 : undefined (8 parallel workers)
      # - trace: 'retain-on-failure' (capture debug artifacts)

    # 6. Upload HTML report (on failure, so you can debug)
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always() # Upload even if tests fail
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30 # Keep artifacts for 30 days
      # Access: Go to Actions → Workflow run → Artifacts → Download

    # 7. Upload test results (traces, screenshots, videos)
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: failure() # Only upload on test failures (saves storage)
      with:
        name: test-results
        path: test-results/
        retention-days: 7 # Shorter retention (larger files)
      # Contains:
      # - trace.zip (full execution trace, viewable in Playwright Trace Viewer)
      # - screenshots (on-failure only, per config)
      # - videos (on-failure only, per config)

# MIGRATION STORY CONTEXT:
# 
# Old CI (Jenkins + Selenium):
# - 2-hour runtime (sequential execution)
# - Manual re-runs for flaky tests
# - Only screenshots on failure (no trace/video)
# - Complex Jenkins pipeline config
# 
# New CI (GitHub Actions + Playwright):
# - 15-minute runtime (8 parallel workers)
# - Auto-retry flaky tests (retries: 2)
# - Rich artifacts (trace viewer, video, screenshots)
# - Simple YAML config (this file)
# 
# RESULT:
# - 40% faster feedback (2hr → 15min)
# - Zero false negatives (auto-retry eliminates flakiness)
# - Better debuggability (trace viewer shows every action/assertion)
# - Per-PR testing enabled (fast enough for every PR)

# ADVANCED CONFIGURATIONS (Optional):
# 
# 1. Matrix strategy (test multiple Node versions):
#    strategy:
#      matrix:
#        node-version: [18, 20, 22]
#    steps:
#      - uses: actions/setup-node@v4
#        with:
#          node-version: ${{ matrix.node-version }}
# 
# 2. Sharding (split tests across multiple jobs):
#    strategy:
#      matrix:
#        shard: [1, 2, 3, 4]
#    steps:
#      - run: npx playwright test --shard=${{ matrix.shard }}/4
# 
# 3. Browser matrix (Chromium + Firefox + WebKit):
#    First, update playwright.config.ts to define multiple projects
#    Then CI will automatically run all projects in parallel
# 
# 4. Deploy preview environment:
#    - name: Deploy preview
#      run: |
#        # Deploy to staging/preview URL
#        # Update baseURL in playwright.config.ts
#        # Run tests against preview
# 
# 5. Slack/Teams notifications on failure:
#    - name: Notify on failure
#      if: failure()
#      uses: 8398a7/action-slack@v3
#      with:
#        status: ${{ job.status }}
#        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

# COST OPTIMIZATION:
# - Use 'npm ci' instead of 'npm install' (faster, deterministic)
# - Install only needed browsers (chromium vs all three)
# - Upload artifacts only on failure (saves storage)
# - Set retention-days to balance debuggability vs cost
# - Use matrix sharding only if tests take > 30min

# SECURITY BEST PRACTICES:
# - Never commit secrets (use GitHub Secrets)
# - Use actions/checkout@v4 (pinned major version)
# - Review action permissions (GITHUB_TOKEN scope)
# - Use 'npm ci' to avoid supply chain attacks (uses lock file)
